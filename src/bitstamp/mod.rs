use serde::{Deserialize, Serialize};
use serde_this_or_that::as_f64;

#[derive(Debug, Serialize, Deserialize)]
pub struct Subscribe {
    pub event: String,
    pub data: SubscribeData,
}

#[derive(Debug, Serialize, Deserialize)]
pub struct SubscribeData {
    pub channel: String,
}

#[derive(Debug, Deserialize)]
pub struct PartialDepthUpdate {
    pub data: DepthUpdateData,
    pub channel: String,
    pub event: String,
}

#[derive(Debug, Deserialize)]
pub struct DiffDepthUpdate {
    pub data: DepthUpdateData,
    pub channel: String,
    pub event: String,
}

#[derive(Debug, Deserialize)]
pub struct DepthUpdateData {
    pub timestamp: String,
    pub microtimestamp: String,
    pub bids: Vec<DepthUpdateValues>,
    pub asks: Vec<DepthUpdateValues>,
}

#[derive(Debug, Deserialize)]
// #[serde(expecting = "expecting [<key>, <price>, <quantity>] array")]
pub struct DepthUpdateValues {
    #[serde(deserialize_with = "as_f64")]
    pub price: f64,
    #[serde(deserialize_with = "as_f64")]
    pub quantity: f64,
}

#[cfg(test)]
mod tests {
    use super::*;
    use tracing_test::traced_test;

    #[test]
    #[traced_test]
    fn test_subscribe() {
        let json = r#"{"event":"bts:subscribe","data":{"channel":"order_book_btcusd"}}"#;
        let subscribe = serde_json::from_str::<Subscribe>(json).unwrap();
        assert_eq!(subscribe.event, "bts:subscribe");
        assert_eq!(subscribe.data.channel, "order_book_btcusd");
    }

    #[test]
    #[traced_test]
    fn test_depth_100() {
        let json = r#"{"data":{"timestamp":"1692790833","microtimestamp":"1692790833031925","bids":[["25922","1.56079593"],["25921","1.27154589"],["25920","0.77158665"],["25919","0.36178794"],["25918","0.30723534"],["25914","1.58406371"],["25912","0.83182734"],["25911","0.44072590"],["25910","0.30133431"],["25908","0.17354598"],["25907","0.32763398"],["25906","1.15800814"],["25904","2.78019151"],["25903","0.75235057"],["25901","0.00263502"],["25900","0.33000000"],["25899","1.00332775"],["25898","0.00263520"],["25896","6.86341348"],["25895","0.61434815"],["25894","1.27775436"],["25893","0.75273800"],["25892","0.32500000"],["25891","0.00263615"],["25890","0.75285430"],["25889","2.83430000"],["25888","0.42263656"],["25887","0.75297063"],["25886","5.45403948"],["25885","0.00263696"],["25884","2.05308699"],["25883","0.32500000"],["25882","0.00263737"],["25881","0.75320338"],["25880","0.32500000"],["25879","2.70243778"],["25878","0.75331977"],["25877","0.32500000"],["25876","0.00263819"],["25875","0.75343622"],["25874","0.32500000"],["25873","0.00263860"],["25872","0.38651776"],["25871","4.14627584"],["25870","0.00263900"],["25868","4.90774759"],["25866","0.00351935"],["25865","0.75382467"],["25864","0.32500000"],["25862","0.75394127"],["25861","0.32500000"],["25860","0.38668663"],["25859","0.75405789"],["25856","0.32500000"],["25853","0.32500000"],["25848","0.32500000"],["25846","2.59580000"],["25843","0.32500000"],["25838","0.32500000"],["25835","12.98760572"],["25831","0.32500000"],["25826","0.32500000"],["25824","0.48381350"],["25822","0.32500000"],["25817","0.32500000"],["25814","0.32500000"],["25810","0.32500000"],["25809","7.93047628"],["25808","4.82109350"],["25806","2.00000000"],["25800","0.00129060"],["25783","5.12911756"],["25777","0.10000000"],["25750","0.01100000"],["25702","5.12911756"],["25700","0.00380000"],["25699","0.00117086"],["25671","0.00077675"],["25650","0.02000000"],["25640","0.00100000"],["25637","0.00077778"],["25620","1.00000000"],["25603","9.10100552"],["25601","0.00101559"],["25600","0.16905545"],["25593","0.01081402"],["25550","0.01000000"],["25543","0.02134752"],["25537","0.02232051"],["25510","0.10000000"],["25504","0.00078183"],["25501","0.00101957"],["25500","2.09553096"],["25405","0.00981114"],["25403","0.00078494"],["25401","0.00102358"],["25400","2.06000000"],["25399","0.01129965"],["25392","0.01169163"],["25383","0.25000000"]],"asks":[["25925","0.04162379"],["25926","0.77143354"],["25927","0.77141836"],["25928","0.77139010"],["25929","0.06000000"],["25930","0.95342152"],["25932","0.15422562"],["25933","2.35529679"],["25934","0.00077000"],["25935","0.11573926"],["25936","0.38500000"],["25937","2.27255712"],["25938","2.68386781"],["25939","0.32500000"],["25942","0.19740538"],["25943","0.32500000"],["25944","0.20717782"],["25946","3.75414152"],["25947","0.00262877"],["25949","3.05170000"],["25950","0.00262836"],["25952","0.30000000"],["25953","0.32500000"],["25954","0.00350381"],["25955","0.00832000"],["25956","0.32500000"],["25957","3.70060895"],["25959","0.32500000"],["25960","0.42262701"],["25962","4.15403948"],["25963","0.00262661"],["25965","1.62500000"],["25966","0.00262620"],["25968","3.06100000"],["25969","0.00262580"],["25971","4.15403948"],["25972","0.00262540"],["25973","0.38502370"],["25974","0.32500000"],["25975","0.00262499"],["25976","2.71830000"],["25977","0.32500000"],["25978","0.00262459"],["25980","0.32500000"],["25982","0.38839432"],["25983","0.32500000"],["25985","0.00262365"],["25986","0.32500000"],["25988","0.00262324"],["25989","0.32500000"],["25992","12.66260572"],["25995","0.32500000"],["25999","0.32500000"],["26002","2.91020000"],["26005","0.32500000"],["26010","1.05000000"],["26015","0.00638856"],["26016","0.01107854"],["26017","0.01261831"],["26018","27.96360611"],["26021","0.74786416"],["26024","0.74774921"],["26027","0.74763429"],["26030","0.74751940"],["26033","0.74740454"],["26036","0.74728971"],["26037","0.50000000"],["26040","0.99619497"],["26043","0.74702191"],["26046","0.74690718"],["26049","0.74679249"],["26052","0.74667783"],["26054","7.93047628"],["26055","27.91060867"],["26090","0.05420000"],["26093","28.10544587"],["26096","0.74499953"],["26104","5.12911756"],["26110","0.01303000"],["26182","0.00200000"],["26200","1.61980300"],["26201","0.00099615"],["26222","5.12911756"],["26240","7.84874827"],["26245","5.00000000"],["26250","16.47551332"],["26255","5.00000000"],["26260","5.00000000"],["26277","0.00300000"],["26280","5.00000000"],["26290","5.00000000"],["26300","5.06827893"],["26301","0.00099236"],["26315","2.50000000"],["26320","2.50000000"],["26325","2.50000000"],["26330","2.50000000"],["26335","0.00184257"],["26336","0.00376257"],["26400","4.10382953"]]},"channel":"order_book_btcusd","event":"data"}"#;
        let depth_update = serde_json::from_str::<PartialDepthUpdate>(json).unwrap();
        assert_eq!(depth_update.data.timestamp, "1692790833");
        assert_eq!(depth_update.data.microtimestamp, "1692790833031925");
        assert_eq!(depth_update.data.bids.len(), 100);
        assert_eq!(depth_update.data.asks.len(), 100);
    }

    #[test]
    #[traced_test]
    fn test_diff_depth() {
        let json = r#"{"data":{"timestamp":"1692790478","microtimestamp":"1692790478220850","bids":[["25938","0.53710231"],["25935","0.32500000"]],"asks":[["25943","1.56420096"]]},"channel":"diff_order_book_btcusd","event":"data"}"#;
        let depth_update = serde_json::from_str::<DiffDepthUpdate>(json).unwrap();
        assert_eq!(depth_update.channel, "diff_order_book_btcusd");
        assert_eq!(depth_update.event, "data");
        assert_eq!(depth_update.data.timestamp, "1692790478");
        assert_eq!(depth_update.data.microtimestamp, "1692790478220850");
        assert_eq!(depth_update.data.bids.len(), 2);
        assert_eq!(depth_update.data.asks.len(), 1);
    }
}
